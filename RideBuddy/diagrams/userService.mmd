classDiagram
    direction TB
    
    %% ═══════════════════════════════════════════════════════
    %% API LAYER
    %% ═══════════════════════════════════════════════════════
    
    class AuthController {
        <<ApiController>>
        -IMediator _mediator
        +Register() IActionResult
        +Login() IActionResult
    }
    
    class UsersController {
        <<ApiController>>
        -IMediator _mediator
        +GetUser(id) IActionResult
        +UpdateProfile() IActionResult
    }
    
    %% ═══════════════════════════════════════════════════════
    %% APPLICATION LAYER - Commands & Queries
    %% ═══════════════════════════════════════════════════════
    
    class RegisterUserCommand {
        <<Command>>
        +Email, Password
        +FirstName, LastName
        +PhoneNumber, Role
    }
    
    class LoginUserQuery {
        <<Query>>
        +Email
        +Password
    }
    
    class UpdateUserProfileCommand {
        <<Command>>
        +UserId
        +FirstName, LastName
        +PhoneNumber
    }
    
    class GetUserByIdQuery {
        <<Query>>
        +UserId
    }
    
    %% ═══════════════════════════════════════════════════════
    %% APPLICATION LAYER - Handlers
    %% ═══════════════════════════════════════════════════════
    
    class RegisterUserCommandHandler {
        <<Handler>>
        +Handle() Result~AuthResponseDto~
    }
    
    class LoginUserQueryHandler {
        <<Handler>>
        +Handle() Result~AuthResponseDto~
    }
    
    class UpdateUserProfileCommandHandler {
        <<Handler>>
        +Handle() Result~UserDto~
    }
    
    class GetUserByIdQueryHandler {
        <<Handler>>
        +Handle() UserDto?
    }
    
    %% ═══════════════════════════════════════════════════════
    %% APPLICATION LAYER - DTOs & Interfaces
    %% ═══════════════════════════════════════════════════════
    
    class AuthResponseDto {
        <<DTO>>
        +Token
        +User
    }
    
    class UserDto {
        <<DTO>>
        +Id, Email
        +FirstName, LastName
        +PhoneNumber, Role
    }
    
    class IAuthenticationService {
        <<interface>>
        +ValidateUser()
        +CreateUser()
    }
    
    class IJwtTokenGenerator {
        <<interface>>
        +GenerateToken()
    }
    
    class IEventPublisher {
        <<interface>>
        +Publish()
        +PublishMany()
    }
    
    %% ═══════════════════════════════════════════════════════
    %% DOMAIN LAYER
    %% ═══════════════════════════════════════════════════════
    
    class UserEntity {
        <<AggregateRoot>>
        +UserId Id
        +Email Email
        +PhoneNumber PhoneNumber
        +UserRole Role
        +int Version
        +DomainEvents
        +Register()$ UserEntity
        +UpdateProfile()
    }
    
    class Email {
        <<ValueObject>>
        +string Value
        +Create()$ Result
    }
    
    class PhoneNumber {
        <<ValueObject>>
        +string Value
        +Create()$ Result
    }
    
    class UserId {
        <<ValueObject>>
        +Guid Value
    }
    
    class UserRole {
        <<enum>>
        Driver
        Passenger
    }
    
    class IUserRepository {
        <<interface>>
        +GetById()
        +GetByEmail()
        +Add()
        +Update()
    }
    
    class IUnitOfWork {
        <<interface>>
        +IUserRepository Users
        +SaveChanges()
        +BeginTransaction()
        +CommitTransaction()
    }
    
    %% ═══════════════════════════════════════════════════════
    %% INFRASTRUCTURE LAYER
    %% ═══════════════════════════════════════════════════════
    
    class UserRepository {
        <<implements IUserRepository>>
        Maps Domain ↔ EF
    }
    
    class UnitOfWork {
        <<implements IUnitOfWork>>
        Transaction Management
    }
    
    class AuthenticationService {
        <<implements IAuthenticationService>>
        ASP.NET Identity
    }
    
    class JwtTokenGenerator {
        <<implements IJwtTokenGenerator>>
        JWT Bearer Tokens
    }
    
    class RabbitMqEventPublisher {
        <<implements IEventPublisher>>
        Outbox Pattern
    }
    
    class OutboxProcessor {
        <<BackgroundService>>
        Polls & Publishes
    }
    
    class UserGrpcService {
        <<gRPC Server>>
        +ValidateUser()
        +GetUserInfo()
    }
    
    %% ═══════════════════════════════════════════════════════
    %% RELATIONSHIPS - API → Application
    %% ═══════════════════════════════════════════════════════
    
    AuthController --> RegisterUserCommand
    AuthController --> LoginUserQuery
    UsersController --> GetUserByIdQuery
    UsersController --> UpdateUserProfileCommand
    
    %% ═══════════════════════════════════════════════════════
    %% RELATIONSHIPS - Application Layer
    %% ═══════════════════════════════════════════════════════
    
    RegisterUserCommand --> RegisterUserCommandHandler
    LoginUserQuery --> LoginUserQueryHandler
    UpdateUserProfileCommand --> UpdateUserProfileCommandHandler
    GetUserByIdQuery --> GetUserByIdQueryHandler
    
    RegisterUserCommandHandler --> IAuthenticationService
    RegisterUserCommandHandler --> IJwtTokenGenerator
    RegisterUserCommandHandler --> IUnitOfWork
    RegisterUserCommandHandler --> IEventPublisher
    RegisterUserCommandHandler ..> AuthResponseDto
    
    LoginUserQueryHandler --> IAuthenticationService
    LoginUserQueryHandler --> IJwtTokenGenerator
    LoginUserQueryHandler ..> AuthResponseDto
    
    UpdateUserProfileCommandHandler --> IUnitOfWork
    UpdateUserProfileCommandHandler --> IEventPublisher
    UpdateUserProfileCommandHandler ..> UserDto
    
    GetUserByIdQueryHandler --> IUserRepository
    GetUserByIdQueryHandler ..> UserDto
    
    AuthResponseDto --> UserDto
    
    %% ═══════════════════════════════════════════════════════
    %% RELATIONSHIPS - Domain Layer
    %% ═══════════════════════════════════════════════════════
    
    UserEntity --> Email
    UserEntity --> PhoneNumber
    UserEntity --> UserId
    UserEntity --> UserRole
    
    %% ═══════════════════════════════════════════════════════
    %% RELATIONSHIPS - Infrastructure implements Application
    %% ═══════════════════════════════════════════════════════
    
    UserRepository ..|> IUserRepository
    UnitOfWork ..|> IUnitOfWork
    AuthenticationService ..|> IAuthenticationService
    JwtTokenGenerator ..|> IJwtTokenGenerator
    RabbitMqEventPublisher ..|> IEventPublisher
    
    %% ═══════════════════════════════════════════════════════
    %% RELATIONSHIPS - Infrastructure uses Domain
    %% ═══════════════════════════════════════════════════════
    
    UserRepository --> UserEntity
    UserGrpcService --> IUserRepository
    OutboxProcessor --> RabbitMqEventPublisher
